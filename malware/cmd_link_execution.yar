rule xlsCMDlink
{
		meta:
			description = "Detects an Microsoft Office file that contains the cmd link/formula"
			author = "wit0k"
			date = "2018-06-12"
		
    strings:
			$h1 = { 63 6D 64 03 2F 63 }  // cmd|'/c
			$h2 = { 63 6D 64 03 2F }  // cmd|'/
			$h3 = { 43 4d 44 03 2F }  // CMD|'/
			$h4 = { 63 4d 64 03 2F }  // cMd|'/
			$h5 = { 63 6d 44 03 2F }  // cmD|'/
			$h6 = { 43 6d 64 03 2F }  // Cmd|'/

    condition:
        (uint32be(0) == 0xd0cf11e0) and (any of them)
}

rule xlsCMDlinkLOLBin
{
		meta:
			description = "Detects a file (text/csv) that contains the cmd link/formula and a lolbin app"
			author = "wit0k"
			date = "2018-06-12"
		
    strings:
			$p1 = /cmd\|'\/c/ nocase ascii wide
			$p2 = /cmd\|'\// nocase ascii wide
      $r1 = /cmd/ nocase ascii wide
			$r2 = /powershell/ nocase ascii wide
			$r3 = /Atbroker/ nocase ascii wide
			$r4 = /Bash/ nocase ascii wide
			$r5 = /Bitsadmin/ nocase ascii wide
			$r6 = /Certutil/ nocase ascii wide
			$r7 = /Cmdkey/ nocase ascii wide
			$r8 = /Cmstp/ nocase ascii wide
			$r9 = /Control/ nocase ascii wide
			$r10 = /Csc/ nocase ascii wide
			$r11 = /Cscript/ nocase ascii wide
			$r12 = /Dfsvc/ nocase ascii wide
			$r13 = /Diskshadow/ nocase ascii wide
			$r14 = /Dnscmd/ nocase ascii wide
			$r15 = /Esentutl/ nocase ascii wide
			$r16 = /Extexport/ nocase ascii wide
			$r17 = /Extrac32/ nocase ascii wide
			$r18 = /Expand/ nocase ascii wide
			$r19 = /Explorer/ nocase ascii wide
			$r20 = /Findstr/ nocase ascii wide
			$r21 = /Forfiles/ nocase ascii wide
			$r22 = /Gpscript/ nocase ascii wide
			$r23 = /Hh/ nocase ascii wide
			$r24 = /Ieexec/ nocase ascii wide
			$r25 = /Ie4uinit/ nocase ascii wide
			$r26 = /Infdefaultinstall/ nocase ascii wide
			$r27 = /Installutil/ nocase ascii wide
			$r28 = /Makecab/ nocase ascii wide
			$r29 = /Mavinject/ nocase ascii wide
			$r30 = /Msbuild/ nocase ascii wide
			$r31 = /Msconfig/ nocase ascii wide
			$r32 = /Msdt/ nocase ascii wide
			$r33 = /Mshta/ nocase ascii wide
			$r34 = /Msiexec/ nocase ascii wide
			$r35 = /Netsh/ nocase ascii wide
			$r36 = /Nltest/ nocase ascii wide
			$r37 = /Odbcconf/ nocase ascii wide
			$r38 = /Openwith/ nocase ascii wide
			$r39 = /Pcalua/ nocase ascii wide
			$r40 = /Pcwrun/ nocase ascii wide
			$r41 = /Powershell/ nocase ascii wide
			$r42 = /Presentationhost/ nocase ascii wide
			$r43 = /Print/ nocase ascii wide
			$r44 = /Psr/ nocase ascii wide
			$r45 = /Reg/ nocase ascii wide
			$r46 = /Regedit/ nocase ascii wide
			$r47 = /Regasm/ nocase ascii wide
			$r48 = /Register-cimprovider/ nocase ascii wide
			$r49 = /Regsvcs/ nocase ascii wide
			$r50 = /Regsvr32/ nocase ascii wide
			$r51 = /Replace/ nocase ascii wide
			$r52 = /Robocopy/ nocase ascii wide
			$r53 = /Rpcping/ nocase ascii wide
			$r54 = /Rundll32/ nocase ascii wide
			$r55 = /Runonce/ nocase ascii wide
			$r56 = /Runscripthelper/ nocase ascii wide
			$r57 = /Sc/ nocase ascii wide
			$r58 = /Scriptrunner/ nocase ascii wide
			$r59 = /Syncappvpublishingserver/ nocase ascii wide
			$r60 = /Wab/ nocase ascii wide
			$r61 = /Wmic/ nocase ascii wide
			$r62 = /Wscript/ nocase ascii wide
			$r63 = /Xwizard/ nocase ascii wide

    condition:
        ($p1 or $p2) and (any of ($r*))
}

rule xlsCMDlinkSoft
{
		meta:
			description = "Detects a file (text/csv) that contains the cmd link/formula and a lolbin app"
			author = "wit0k"
			date = "2018-06-12"
		
    strings:
			$p1 = /cmd\|'\/c/ nocase ascii wide
			$p2 = /cmd\|'\// nocase ascii wide
      		$p3 = /MSEXCEL.{2,}cmd\.exe/ nocase ascii wide
       
    condition:
        any of them
}